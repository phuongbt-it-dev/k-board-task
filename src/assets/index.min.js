"use strict";function reFresh(t){$('[data-step="step-'+t+'"]').addClass("on-load"),setTimeout(function(){1==t?__index__getData("step-1","P"):2==t?__index__getData("step-2","I"):__index__getData("step-3","D"),$('[data-step="step-'+t+'"]').removeClass("on-load")},1e3),toastrMsg("Cập nhật danh sách hoàn tất","Cập nhật",2e3)}function __index__getData(o,c){$.ajax({url:Global.API_URL+"/tasks.json",type:"GET",dataType:"json",cache:!0,beforeSend:function(t){t.setRequestHeader("Authorization","Bearer "+Cookies.get("Token"))},complete:function(t){App.Data=t.responseJSON;var e=App.Data.filter(function(t){return t.State===c});e.sort(function(t,e){var a=new Date(t.CreatedDate);return new Date(e.CreatedDate)-a}),e.sort(function(t,e){return new Date(t.order)-new Date(e.order)});var a=[];for(var n in e)if(e.hasOwnProperty(n)&&e[n]){var i=e[n].State,s=e[n];i===c&&a.push(App.__template(s.ObjectId,s.MetaIndex,s.Name,s.CreatedDate,s.MetaDescription,s.MetaTextValue,s.CreateID,s.workID,s.ActivatedTS,s.Project,s.Est,s.Material,s.order,s.ObjectType))}if($('[data-step="'+o+'"]').html(a),"step-1"===o){var r=1;$('[data-step="'+o+'"]').find("li").each(function(){r<=Settings.ActiveNumberStep1Drag||$(this).addClass("disabled"),r++})}$('[data-toggle="tooltip"]').tooltip(),__main__callAction(),__main__checkContent()},error:function(t,e,a){}})}function __index__updateTask(t,e){var a="";a="step-1"===e?"P":"step-2"===e?"I":"D",$.ajax({url:"/update",type:"POST",dataType:"json",cache:!0,data:{id:t,State:a},complete:function(t){t.responseJSON}})}function __index__sortAble(){$("#k-board-task .sortable[data-step='step-1']").sortable({connectWith:Settings.OneWay&&0!=Settings.OneWay?"#k-board-task .sortable[data-step='step-2']":".connectedSortable",items:"li:not(.disabled)",placeholder:"ui-highlight",start:function(t,e){e.placeholder.height(e.item.outerHeight()),e.placeholder.html(e.item.html()),e.placeholder.addClass("list-group-item list-group-item-action"),__main__checkContent()},update:function(t,e){__main__checkContent(),__main__updateOrder($(t.target).attr("data-step"))},receive:function(t,e){__index__updateTask(e.item.attr("id"),$(t.target).attr("data-step")),__main__checkContent(),__main__updateOrder($(t.target).attr("data-step"))},stop:function(t,e){toastrMsg("Cập nhật danh sách hoàn tất","Cập nhật",2e3)}}).disableSelection(),$("#k-board-task .sortable[data-step='step-2']").sortable({connectWith:Settings.OneWay&&0!=Settings.OneWay?"#k-board-task .sortable[data-step='step-3']":".connectedSortable",items:"li:not(.disabled)",placeholder:"ui-highlight",start:function(t,e){e.placeholder.height(e.item.outerHeight()),e.placeholder.html(e.item.html()),e.placeholder.addClass("list-group-item list-group-item-action"),__main__checkContent()},update:function(t,e){__main__checkContent(),__main__updateOrder($(t.target).attr("data-step"))},receive:function(t,e){$(this).children().length>Settings.ActiveNumberStep2Drop?$(e.sender).sortable("cancel"):(__index__updateTask(e.item.attr("id"),$(t.target).attr("data-step")),(Settings.OneWay||1==Settings.OneWay)&&reFresh(1)),__main__checkContent(),__main__updateOrder($(t.target).attr("data-step"))},stop:function(t,e){toastrMsg("Cập nhật danh sách hoàn tất","Cập nhật",2e3)}}).disableSelection(),$("#k-board-task .sortable[data-step='step-3']").sortable({connectWith:Settings.OneWay&&0!=Settings.OneWay?"":".connectedSortable",items:"li:not(.disabled)",placeholder:"ui-highlight",start:function(t,e){e.placeholder.height(e.item.outerHeight()),e.placeholder.html(e.item.html()),e.placeholder.addClass("list-group-item list-group-item-action"),__main__checkContent()},update:function(t,e){__main__checkContent(),__main__updateOrder($(t.target).attr("data-step"))},receive:function(t,e){__index__updateTask(e.item.attr("id"),$(t.target).attr("data-step")),(Settings.OneWay||1==Settings.OneWay)&&reFresh(2),__main__checkContent(),__main__updateOrder($(t.target).attr("data-step"))},stop:function(t,e){toastrMsg("Cập nhật danh sách hoàn tất","Cập nhật",2e3)}}).disableSelection(),Settings.Permission.ActiveDashboard&&0!=Settings.Permission.ActiveDashboard||$(".connectedSortable").sortable("disable")}function __index__onResize(){setTimeout(function(){var t=$("#pdfModal .modal-body").height();$("#pdfModal .modal-body iframe").css({height:t+"px"}),$("#pdfModal .modal-body").css({height:t+"px"}),initIframe()},1e3)}function doArchive(e){if(!confirm("Bạn có chắc chắn lưu trữ task này?"))return!1;$.ajax({url:"/archive",type:"POST",dataType:"json",cache:!0,data:{id:e,State:"N"},complete:function(t){$("#"+e).remove()}})}function moveTask(t){var e=$(t).parents("ul").attr("data-step"),a=$(t).parents("li"),n=$(t).parents("li").attr("id");if(!confirm("Bạn có chắc chắn di dời task này?"))return!1;Settings.Permission.MoveTask?"step-1"===e?$('[data-step="step-2"]').children().length>=Settings.ActiveNumberStep2Drop?alert("Đã vượt quá giới hạn của nhiệm vụ"):($(a).clone().prependTo('[data-step="step-2"]'),$(a).remove(),__index__updateTask(n,"step-2"),__main__checkContent(),__main__updateOrder("step-1"),__main__updateOrder("step-2"),reFresh(1)):"step-2"===e&&($(a).clone().prependTo('[data-step="step-3"]'),$(a).remove(),__index__updateTask(n,"step-3"),__main__checkContent(),__main__updateOrder("step-2"),__main__updateOrder("step-3"),reFresh(2)):alert("Bạn không có quyền di chuyển nhiệm vụ!")}checkLogin(!0),$(document).ready(function(){__index__getData("step-1","P"),__index__getData("step-2","I"),__index__getData("step-3","D"),__index__sortAble(),__main__addForm()}),$(window).resize(function(){__index__onResize()}),$(function(){$.contextMenu.types.label=function(t,e,a){$('<span>Độ ưu tiên<ul><li class="label1" data-val="0">Thấp</li><li class="label2" data-val="1">Bình thường</li><li class="label3" data-val="2">Trung bình</li><li class="label4" data-val="3">Cao</li></ul></span>').appendTo(this).on("click","li",function(){var e=$(a.$trigger[0]).parents(".list-group").attr("data-step");Settings.Permission.ModifyTask?($.ajax({url:"/modify",type:"POST",dataType:"json",cache:!0,data:{id:$(a.$trigger[0]).attr("id"),MetaIndex:$(this).attr("data-val")},complete:function(t){reFresh("step-1"===e?1:"step-2"===e?2:3)}}),a.$menu.trigger("contextmenu:hide")):alert("Bạn không có quyền tùy chỉnh nhiệm vụ!")}),this.addClass("labels").on("contextmenu:focus",function(t){}).on("contextmenu:blur",function(t){}).on("keydown",function(t){})},$.contextMenu({selector:".list-group-item-action",events:{show:function(t){var e=$($(t)[0].$trigger[0]).attr("id"),a=$("#"+e).parents("ul").attr("data-step");$(t.$menu).addClass(a)},hide:function(t){var e=$($(t)[0].$trigger[0]).attr("id"),a=$("#"+e).parents("ul").attr("data-step");$(t.$menu).removeClass(a)}},callback:function(t,e,a,n){var i=$(this),s=$(this).attr("id");if(Settings.Permission.DeleteTask){if(!confirm("Bạn có chắc chắn xóa task này?"))return!1;$.ajax({url:"/delete",type:"POST",dataType:"json",cache:!0,data:{id:s},beforeSend:function(t){t.setRequestHeader("Authorization","Bearer "+Cookies.get("Token"))},complete:function(t){$(i).remove()}})}else alert("Bạn không có quyền xóa nhiệm vụ!")},items:{open:{name:"Xem chi tiết",icon:"edit",callback:function(t,e,a,n){var i=$(this).attr("id");Settings.Permission.ViewTask?window.location.href="/gettask?id="+i:alert("Bạn không có quyền xem nhiệm vụ!")}},label:{type:"label",className:"position-item",customName:"Label",callback:$.noop},archive:{name:"Lưu lại",icon:"copy",className:"archive-item",callback:function(t,e,a,n){var i=$(this).attr("id");Settings.Permission.ArchiveTask?doArchive(i):alert("Bạn không có quyền lưu trữ nhiệm vụ!")}},delete:{name:"Xóa",icon:"delete",className:"archive-item"}}})});